<!DOCTYPE html>
<html>
<head>
    <title>Trainer Schedule</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <style>
        .highlight-event {
            background-color: #ffcc00 !important;
            border-color: #ff9900 !important;
        }
        .calendar-container {
            display: flex;
            justify-content: center;
        }
        .fc-popover {
            z-index: 9999 !important;
        }
        /* Dark mode styles */
        body.dark-mode {
            background-color: #181818 !important;
            color: #eee !important;
        }
        body.dark-mode .card, body.dark-mode .fc-tooltip {
            background: #23272b !important;
            color: #eee !important;
            border-color: #444 !important;
        }
        body.dark-mode .fc {
            background: #23272b !important;
            color: #eee !important;
        }
        body.dark-mode .fc-toolbar-title,
        body.dark-mode .fc-button,
        body.dark-mode .fc-col-header-cell,
        body.dark-mode .fc-daygrid-day-number {
            color: #eee !important;
        }
        body.dark-mode .fc-button-primary {
            background-color: #444 !important;
            border-color: #666 !important;
        }
        body.dark-mode .fc-button-primary:not(:disabled):active,
        body.dark-mode .fc-button-primary:not(:disabled).fc-button-active {
            background-color: #666 !important;
            border-color: #888 !important;
        }
        .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-3 calendar-container">
        <div style="width:100%;">
            <div class="top-bar">
                <button id="toggle-dark" class="btn btn-dark" title="Toggle dark mode">üåô</button>
                <a href="{% url 'logout' %}" class="btn btn-secondary">Logout</a>
                {% if request.user.is_superuser %}
                    <a href="{% url 'admin_schedule' %}" class="btn btn-primary">Admin Schedule</a>
                {% endif %}
            </div>
            <h2>Your Schedule</h2>
            {% if error %}
                <p class="text-danger">{{ error }}</p>
            {% else %}
                <div id="calendar"></div>
                {{ events|json_script:"events-data" }}
            {% endif %}
        </div>
    </div>
    {% if not error %}
    <script>
        // Dark mode persistence and icon
        function setDarkMode(on) {
            if (on) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'on');
                document.getElementById('toggle-dark').innerText = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'off');
                document.getElementById('toggle-dark').innerText = 'üåô';
            }
        }
        // On page load, set dark mode if needed
        if (localStorage.getItem('darkMode') === 'on') {
            setDarkMode(true);
        } else {
            setDarkMode(false);
        }
        document.getElementById('toggle-dark').onclick = function() {
            setDarkMode(!document.body.classList.contains('dark-mode'));
        };

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var eventsDataElement = document.getElementById('events-data');
            if (eventsDataElement) {
                var eventsData = JSON.parse(eventsDataElement.textContent);

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    views: {
                        dayGridMonth: { buttonText: 'Month' },
                        timeGridWeek: { buttonText: 'Week' },
                        timeGridDay: { buttonText: 'Day' }
                    },
                    events: eventsData,
                    timeZone: 'Asia/Kolkata',
                    eventMouseEnter: function(info) {
                        // Show Bootstrap tooltip with summary
                        var summary = info.event.extendedProps.summary || '';
                        var tooltip = document.createElement('div');
                        tooltip.className = 'fc-tooltip card p-2 shadow';
                        tooltip.style.position = 'absolute';
                        tooltip.style.zIndex = 10000;
                        tooltip.innerText = summary;
                        document.body.appendChild(tooltip);

                        function moveTooltip(e) {
                            tooltip.style.left = (e.pageX + 10) + 'px';
                            tooltip.style.top = (e.pageY + 10) + 'px';
                        }
                        info.el.addEventListener('mousemove', moveTooltip);
                        info.el.addEventListener('mouseleave', function() {
                            tooltip.remove();
                            info.el.removeEventListener('mousemove', moveTooltip);
                        });
                    },
                    eventClassNames: function(info) {
                        return info.event.extendedProps.highlight ? ['highlight-event'] : [];
                    },
                    nowIndicator: true // Show current time indicator
                });
                calendar.render();
            } else {
                console.error("Events data element not found");
            }
        });
    </script>
    {% endif %}
</body>
</html>